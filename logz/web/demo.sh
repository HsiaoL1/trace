#!/bin/bash

# æ—¥å¿—ç®¡ç†ç³»ç»Ÿ Web ç•Œé¢æ¼”ç¤ºè„šæœ¬

echo "=========================================="
echo "    æ—¥å¿—ç®¡ç†ç³»ç»Ÿ Web ç•Œé¢æ¼”ç¤º"
echo "=========================================="

# æ£€æŸ¥Goç¯å¢ƒ
if ! command -v go &> /dev/null; then
    echo "é”™è¯¯: æœªæ‰¾åˆ°Goç¯å¢ƒï¼Œè¯·å…ˆå®‰è£…Go"
    exit 1
fi

# è®¾ç½®ç¯å¢ƒå˜é‡
export LOG_DIR="logs"
export PORT="8080"

# åˆ›å»ºæ—¥å¿—ç›®å½•
mkdir -p "$LOG_DIR"

echo "æ—¥å¿—ç›®å½•: $LOG_DIR"
echo "æœåŠ¡ç«¯å£: $PORT"
echo ""

# å¯åŠ¨æ—¥å¿—ç”Ÿæˆå™¨ï¼ˆåå°è¿è¡Œï¼‰
echo "å¯åŠ¨æ—¥å¿—ç”Ÿæˆå™¨..."
go run demo.go &
DEMO_PID=$!

# ç­‰å¾…ä¸€ä¸‹è®©æ—¥å¿—ç”Ÿæˆå™¨å¯åŠ¨
sleep 2

# å¯åŠ¨WebæœåŠ¡å™¨ï¼ˆåå°è¿è¡Œï¼‰
echo "å¯åŠ¨WebæœåŠ¡å™¨..."
go run main.go &
WEB_PID=$!

# ç­‰å¾…ä¸€ä¸‹è®©WebæœåŠ¡å™¨å¯åŠ¨
sleep 3

echo ""
echo "=========================================="
echo "    æ¼”ç¤ºå·²å¯åŠ¨ï¼"
echo "=========================================="
echo ""
echo "ğŸŒ Webç•Œé¢: http://localhost:$PORT"
echo "ğŸ“ æ—¥å¿—ç›®å½•: $LOG_DIR"
echo ""
echo "åŠŸèƒ½æ¼”ç¤º:"
echo "1. æ‰“å¼€æµè§ˆå™¨è®¿é—® http://localhost:$PORT"
echo "2. æŸ¥çœ‹ä¸»é¡µé¢ç»Ÿè®¡ä¿¡æ¯å’Œæ–‡ä»¶åˆ—è¡¨"
echo "3. ä½¿ç”¨é«˜çº§æœç´¢åŠŸèƒ½"
echo "4. ç‚¹å‡»æ–‡ä»¶æŸ¥çœ‹è¯¦ç»†æ—¥å¿—"
echo "5. è®¿é—®é”™è¯¯æ—¥å¿—é¡µé¢"
echo ""
echo "æŒ‰ Ctrl+C åœæ­¢æ¼”ç¤º..."

# ç­‰å¾…ç”¨æˆ·ä¸­æ–­
trap 'cleanup' INT

wait

cleanup() {
    echo ""
    echo "æ­£åœ¨åœæ­¢æ¼”ç¤º..."
    
    # åœæ­¢æ—¥å¿—ç”Ÿæˆå™¨
    if kill -0 $DEMO_PID 2>/dev/null; then
        kill $DEMO_PID
        echo "âœ“ æ—¥å¿—ç”Ÿæˆå™¨å·²åœæ­¢"
    fi
    
    # åœæ­¢WebæœåŠ¡å™¨
    if kill -0 $WEB_PID 2>/dev/null; then
        kill $WEB_PID
        echo "âœ“ WebæœåŠ¡å™¨å·²åœæ­¢"
    fi
    
    echo ""
    echo "æ¼”ç¤ºå·²ç»“æŸï¼"
    exit 0
} 